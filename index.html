<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokechill Save Editor</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #2d3436;
            --border: #dfe6e9;
            --danger: #d63031;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        h1 { text-align: center; color: var(--primary); margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; font-size: 14px; margin-bottom: 30px; }
        h2 { border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-top: 40px; color: #555; font-size: 18px; }

        .controls {
            text-align: center;
            background: #fff;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        .controls:hover { border-color: var(--primary); }

        /* --- Team Editor --- */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 20px;
        }

        .pkmn-card {
            background: #fff;
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            padding: 15px;
            font-size: 13px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .pkmn-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            font-weight: bold;
            color: #b2bec3;
            letter-spacing: 0.5px;
        }

        .shiny-label { 
            color: #e17055; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            font-size: 12px;
            user-select: none;
        }
        .shiny-label input { margin-right: 4px; }

        .form-row { display: flex; align-items: center; margin-bottom: 8px; }
        .form-row label { width: 65px; color: #636e72; font-weight: 600; font-size: 12px; }
        .form-row input { 
            flex: 1; 
            padding: 6px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-family: 'Consolas', monospace;
            font-size: 13px;
            transition: border-color 0.2s;
        }
        .form-row input:focus { border-color: var(--primary); outline: none; }
        
        /* --- 自定义联想菜单样式 --- */
        .ac-wrapper {
            position: relative;
            flex: 1; 
        }
        .ac-wrapper input {
            width: 100%;
            box-sizing: border-box;
        }
        .ac-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }
        .ac-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            font-size: 13px;
            color: #333;
        }
        .ac-item:hover {
            background-color: #f0f8ff;
            color: var(--primary);
        }

        /* IV Editor Styles */
        .iv-section-title {
            font-size: 11px;
            font-weight: bold;
            color: #a4b0be;
            margin-top: 12px;
            margin-bottom: 6px;
            border-top: 1px dashed #eee;
            padding-top: 8px;
        }
        .iv-row {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            margin-bottom: 5px;
        }
        .iv-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        .iv-group label {
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
            font-weight: 600;
        }
        .iv-group input {
            width: 100%;
            text-align: center;
            padding: 4px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
        }

        .moves-box { 
            background: #f1f2f6; 
            padding: 10px; 
            border-radius: 6px; 
            margin-top: 10px; 
        }
        .moves-title { font-size: 11px; font-weight: bold; color: #a4b0be; margin-bottom: 6px; }

        /* --- Dex Editor Styles --- */
        .dex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border);
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
        }
        .dex-card {
            background: #fff;
            border: 1px solid #eee;
            border-top: 3px solid #00b894; /* Green accent for Dex */
            padding: 12px;
            border-radius: 6px;
        }

        /* --- Item Editor --- */
        .search-bar {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }
        
        /* Flex container for Search + Button */
        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .action-btn {
            background: #00b894;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0 20px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .action-btn:hover { background: #00a884; }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--border);
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
        }

        .item-card {
            background: #fff;
            border: 1px solid #eee;
            padding: 12px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .item-cn { font-weight: bold; font-size: 14px; color: #2d3436; }
        .item-en { font-size: 11px; color: #999; font-family: monospace; }
        
        .qty-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .qty-row span { font-size: 12px; color: #666; }
        .qty-row input { width: 80px; text-align: right; padding: 4px; border: 1px solid #ddd; border-radius: 4px; }

        .tag-auto { font-size: 10px; background: #dfe6e9; color: #636e72; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }

        /* --- Footer --- */
        .save-btn {
            display: block;
            width: 240px;
            margin: 40px auto 0;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }
        .save-btn:hover { background: #5649c0; transform: translateY(-2px); }
        .save-btn:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; transform: none; }

        #errorMsg { color: #d63031; text-align: center; display: none; margin-top: 15px; font-weight: bold; }

        /* Learn All Button Style */
        .btn-learn-all {
            font-size: 9px; 
            padding: 2px 6px; 
            cursor: pointer; 
            border: 1px solid #0984e3; 
            background: #fff; 
            color: #0984e3;
            border-radius: 3px;
        }
        .btn-learn-all:hover { background: #0984e3; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1>Pokechill Save Editor (Full Skills Ver)</h1>
    <div class="subtitle">Support Team Editing & Dex/Storage Editing (Level, IVs, Shiny) & Items</div>
    
    <div class="controls">
        <input type="file" id="fileInput" accept=".json">
        <div id="errorMsg"></div>
    </div>

    <div id="mainArea" style="display:none;">
        <h2>Team Editor (Active Party)</h2>
        <div class="team-grid" id="teamGrid">
            </div>

        <h2>Dex / Storage Editor (批量修改仓库/图鉴)</h2>
        <div class="search-row">
            <input type="text" id="dexSearchBox" class="search-bar" style="margin-bottom:0;" placeholder="搜索宝可梦 ID / Search Species ID (e.g. charizard)...">
            <button id="unlockAllDexBtn" class="action-btn">一键全图鉴 (Unlock All)</button>
        </div>
        <div class="dex-grid" id="dexGrid">
            </div>

        <h2>Item Editor (物品修改)</h2>
        <input type="text" id="itemSearchBox" class="search-bar" placeholder="搜索物品名称 / Search Items...">
        <div class="item-grid" id="itemGrid">
            </div>

        <button id="saveBtn" class="save-btn">保存修改并下载 (Save & Download)</button>
    </div>
</div>

<script>
    let jsonData = null;
    let activePreviewKey = "preview1"; 

    // 用于存储自动补全的数据源
    let searchDB = { pkmn: [], items: [], abilities: [], moves: [] };

    // --- 0. 静态全技能库 (提取自 1.9 全技能存档) ---
    const FULL_SKILL_LIB = [
        "accelerock", "acid", "acidArmor", "acidSpray", "acrobatics", "agility", "airShlash", "alluringVoice", "amnesia", "ancientPower", 
        "aquaJet", "aquaTail", "armThrust", "aromaticMist", "auraSphere", "auroraBeam", "avalanche", "babydollEyes", "barrier", "bite", 
        "blizzard", "bodyPress", "bounce", "brickBreak", "bubbleBeam", "bugBite", "bugBuzz", "bulkUp", "bulldoze", "bulletPunch", "bulletSeed", 
        "calmMind", "chargeBeam", "charm", "chillingWater", "closeCombat", "coil", "confuseRay", "confusion", "cottonSpore", "crossPoison", 
        "crunch", "cut", "darkPulse", "dazzlingGleam", "dig", "disarmingVoice", "discharge", "dizzyPunch", "doubleHit", "doubleSlap", 
        "dracoMeteor", "dragonBreath", "dragonClaw", "dragonDance", "dragonPulse", "dragonRush", "dragonTail", "drillPeck", "dualChop", 
        "dualWingbeat", "earthPower", "earthquake", "electricTerrain", "electroWeb", "ember", "energyBall", "extrasensory", "extremeSpeed", 
        "facade", "fairyWind", "fakeTears", "featherDance", "feintAttack", "fireBlast", "fireFang", "firePunch", "fireSpin", "flameCharge", 
        "flamethrower", "flareBlitz", "flashCannon", "fly", "focusBlast", "fog", "forcePalm", "frostBreath", "furyCutter", "gigaImpact", 
        "grassyTerrain", "growl", "gust", "hail", "heatWave", "hex", "honeClaws", "hurricane", "hydroPump", "hyperBeam", "hyperVoice", 
        "iceBeam", "iceFang", "icePunch", "iceShard", "icicleCrash", "icicleSpear", "icyWind", "incinerate", "infestation", "ironDefense", 
        "ironHead", "ironTail", "knockOff", "leafBlade", "leafage", "leer", "lick", "liquidation", "lowSweep", "machPunk", "magicalLeaf", 
        "magnetBomb", "magneticFlux", "magnitude", "metalClaw", "metalSound", "mirrorShot", "mistyTerrain", "mudShot", "mudSlap", "muddyWater", 
        "nastyPlot", "nightSlash", "nuzzle", "ominousWind", "outrage", "overheat", "peck", "pinMissile", "playNice", "playRough", "poisonFang", 
        "poisonJab", "poisonPowder", "poisonSting", "pounce", "powderSnow", "powerGem", "powerupPunch", "psybeam", "psychic", "psychoCut", 
        "pursuit", "quickAttack", "rainDance", "razorLeaf", "rockBlast", "rockPolish", "rockSlide", "rockSmash", "rockThrow", "rollout", 
        "rototiller", "sandstorm", "scald", "scorchingSands", "screech", "seedBomb", "shadowBall", "shadowClaw", "shadowPunch", "shadowSneak", 
        "signalBeam", "silverWind", "skyDrop", "sludge", "sludgeBomb", "sludgeWave", "smackDown", "smellingSalts", "smog", "snarl", "solarBeam", 
        "solarBlade", "spore", "steelWing", "stickyWeb", "stomp", "stoneEdge", "strength", "stringShot", "struggleBug", "stunSpore", "sunnyDay", 
        "surf", "swagger", "sweetKiss", "swift", "swordsDance", "tackle", "tailwind", "thunder", "thunderFang", "thunderPunch", "thunderShock", 
        "thunderWave", "thunderbolt", "toxic", "twinBeam", "twineedle", "twister", "vacuumWave", "vineWhip", "waterGun", "waterPulse", 
        "waterfall", "whirlpool", "willOWisp", "xScissor"
    ];

    // --- 1. 精准翻译库 ---
    const preciseMap = {
        "rareCandy": "神奇糖果 (升级)", "goldenBottleCap": "金色王冠 (满个体)", "bottleCap": "银色王冠",
        "abilityPatch": "特性药膏 (梦特)", "abilityCapsule": "特性胶囊", "ppUp": "PP提升剂",
        "ppMax": "PP极限提升剂", "masterBall": "大师球", "shinyCharm": "闪光护符",
        "ovalStone": "浑圆之石", "everstone": "不变之石", "destinyKnot": "红线", "expShare": "学习装置",
        "hpUp": "HP增强剂", "protein": "攻击增强剂", "iron": "防御增强剂", "calcium": "特攻增强剂",
        "zinc": "特防增强剂", "carbos": "速度增强剂",
        "fireStone": "火之石", "waterStone": "水之石", "thunderStone": "雷之石", "leafStone": "叶之石",
        "moonStone": "月之石", "sunStone": "日之石", "duskStone": "暗之石", "dawnStone": "觉醒之石",
        "shinyStone": "光之石", "iceStone": "冰之石", "linkStone": "联系绳",
        "leftovers": "吃剩的东西", "lifeOrb": "生命宝珠", "toxicOrb": "剧毒宝珠", "flameOrb": "火焰宝珠",
        "choiceBand": "讲究头带", "choiceSpecs": "讲究眼镜", "choiceScarf": "讲究围巾", "assaultVest": "突击背心",
        "focusSash": "气势披带", "rockyHelmet": "凸凸头盔", "blackGlasses": "黑色眼镜 (恶)", "charcoal": "木炭 (火)",
        "mysticWater": "神秘水滴 (水)", "miracleSeed": "奇迹种子 (草)", "magnet": "磁铁 (电)", "neverMeltIce": "不融冰 (冰)",
        "dragonFang": "龙之牙 (龙)", "spellTag": "诅咒之符 (幽灵)", "blackBelt": "黑带 (格斗)", "sharpBeak": "锐利鸟嘴 (飞行)",
        "poisonBarb": "毒针 (毒)", "softSand": "柔软沙子 (地)", "hardStone": "硬石头 (岩)", "silverPowder": "银粉 (虫)",
        "twistedSpoon": "弯曲的汤匙 (超能)", "metalCoat": "金属膜 (钢)", "silkScarf": "丝绸围巾 (一般)", "fairyFeather": "妖精之羽 (妖精)"
    };

    // --- 2. 自动机翻词典 ---
    const autoDict = {
        "Ball": "球", "Berry": "果", "Stone": "石", "Candy": "糖", "Tm": "技能机", "Key": "钥匙",
        "Pass": "证", "Charm": "护符", "Plate": "石板", "Orb": "宝珠", "Fire": "火", "Water": "水",
        "Thunder": "雷", "Leaf": "叶", "Ice": "冰", "Dragon": "龙", "Fairy": "妖精", "Ghost": "幽灵",
        "Bug": "虫", "Dark": "恶", "Choice": "讲究", "Assault": "突击", "Focus": "气势", "Leftovers": "剩饭",
        "Life": "生命", "Mystic": "神秘", "Miracle": "奇迹", "Never": "不融", "Hard": "硬", "Soft": "软",
        "Sharp": "锐利", "Poison": "毒", "Metal": "金属", "Great": "超级", "Ultra": "特级", "Quick": "先制",
        "Heavy": "沉重", "Wise": "博识", "Muscle": "力量", "Scope": "焦点", "Lens": "镜", "Claw": "爪",
        "Fang": "牙", "Scale": "鳞片", "Powder": "粉", "Spoon": "勺"
    };

    function translateItem(key) {
        if (preciseMap[key]) return { text: preciseMap[key], isAuto: false };
        const words = key.replace(/([A-Z])/g, ' $1').trim().split(' ');
        const translated = words.map(w => {
            const cap = w.charAt(0).toUpperCase() + w.slice(1);
            return autoDict[cap] || w;
        }).join('');
        if (translated.replace(/\s/g, '') === key) return { text: key, isAuto: false };
        return { text: translated, isAuto: true };
    }

    // --- 3. 自动联想逻辑 ---
    function setupAutocomplete(input, dataSource) {
        const listEl = document.createElement('div');
        listEl.className = 'ac-list';
        input.parentNode.appendChild(listEl); 

        input.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            listEl.innerHTML = '';
            if (!val) {
                listEl.style.display = 'none';
                return;
            }

            const matches = dataSource.filter(item => 
                item.toLowerCase().startsWith(val) || item.toLowerCase().includes(val)
            ).slice(0, 30);

            if (matches.length === 0) {
                listEl.style.display = 'none';
                return;
            }

            matches.forEach(match => {
                const div = document.createElement('div');
                div.className = 'ac-item';
                div.textContent = match;
                div.addEventListener('mousedown', function(e) {
                    e.preventDefault(); 
                    input.value = match;
                    listEl.style.display = 'none';
                });
                listEl.appendChild(div);
            });
            listEl.style.display = 'block';
        });

        input.addEventListener('blur', function() {
            setTimeout(() => { listEl.style.display = 'none'; }, 150);
        });
        
        input.addEventListener('focus', function() {
            if(this.value) this.dispatchEvent(new Event('input'));
        });
    }

    // --- 4. 初始化与渲染 ---
    const fileInput = document.getElementById('fileInput');
    const mainArea = document.getElementById('mainArea');
    const teamGrid = document.getElementById('teamGrid');
    const dexGrid = document.getElementById('dexGrid');
    const dexSearchBox = document.getElementById('dexSearchBox');
    const itemGrid = document.getElementById('itemGrid');
    const itemSearchBox = document.getElementById('itemSearchBox');
    const saveBtn = document.getElementById('saveBtn');
    const errorMsg = document.getElementById('errorMsg');
    
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                jsonData = JSON.parse(ev.target.result);
                errorMsg.style.display = 'none';
                
                if (jsonData.saved && jsonData.saved.currentPreviewTeam) {
                    activePreviewKey = jsonData.saved.currentPreviewTeam;
                }
                
                // --- 准备搜索数据 ---
                searchDB = { pkmn: [], items: [], abilities: [], moves: [] };
                const pkmnSet = new Set();
                const itemSet = new Set();
                const abilitySet = new Set();
                const moveSet = new Set();

                // 先把全技能库加进去
                FULL_SKILL_LIB.forEach(m => moveSet.add(m));

                Object.keys(jsonData).forEach(key => {
                    const val = jsonData[key];
                    if (val && typeof val === 'object' && val.hasOwnProperty('got')) {
                        itemSet.add(key);
                    }
                    if (val && typeof val === 'object' && (val.movepool || (val.caught !== undefined && !val.got))) {
                        pkmnSet.add(key);
                        if (val.ability) abilitySet.add(val.ability);
                        if (Array.isArray(val.movepool)) val.movepool.forEach(m => moveSet.add(m));
                        if (val.moves) Object.values(val.moves).forEach(m => { if(m) moveSet.add(m); });
                    }
                });

                searchDB.pkmn = Array.from(pkmnSet).sort();
                searchDB.items = Array.from(itemSet).sort();
                searchDB.abilities = Array.from(abilitySet).sort();
                searchDB.moves = Array.from(moveSet).sort();

                renderTeam();
                renderDex();
                renderItems();
                mainArea.style.display = 'block';
            } catch(err) { 
                console.error(err);
                errorMsg.innerText = "Error: " + err.message;
                errorMsg.style.display = 'block';
            }
        };
        reader.readAsText(file);
    });

    // --- Render Team ---
    function renderTeam() {
        teamGrid.innerHTML = '';
        const previewData = jsonData.saved.previewTeams[activePreviewKey];
        if (!previewData) {
            teamGrid.innerHTML = '<div>Error: Could not find active preview team data.</div>';
            return;
        }

        for (let i = 1; i <= 6; i++) {
            const slotKey = 'slot' + i;
            const configSlot = previewData[slotKey]; 
            
            if (!configSlot || !configSlot.pkmn) {
                const empty = document.createElement('div');
                empty.className = 'pkmn-card';
                empty.innerHTML = `<div class="pkmn-header">SLOT ${i}</div><div style="color:#ccc;">Empty</div>`;
                teamGrid.appendChild(empty);
                continue;
            }

            const speciesId = configSlot.pkmn;
            const rootPkmn = jsonData[speciesId] || { moves: {}, ability: "", shiny: false, ivs: {} };
            if (!rootPkmn.moves) rootPkmn.moves = {};
            const level = rootPkmn.level || 100;
            const ivs = rootPkmn.ivs || { hp:31, atk:31, def:31, satk:31, sdef:31, spe:31 };

            const card = document.createElement('div');
            card.className = 'pkmn-card';
            card.dataset.slotKey = slotKey; 
            
            card.innerHTML = `
                <div class="pkmn-header">
                    <span>SLOT ${i}</span>
                    <label class="shiny-label">
                        <input type="checkbox" class="inp-shiny" ${rootPkmn.shiny ? 'checked' : ''}> Shiny
                    </label>
                </div>
                
                <div class="form-row">
                    <label>Species</label>
                    <div class="ac-wrapper">
                        <input type="text" class="inp-id" value="${speciesId}" autocomplete="off">
                    </div>
                </div>
                
                <div class="form-row"><label>Level</label><input type="number" class="inp-level" value="${level}" min="1" max="100"></div>
                
                <div class="form-row">
                    <label>Item</label>
                    <div class="ac-wrapper">
                        <input type="text" class="inp-item" value="${configSlot.item || ''}" autocomplete="off">
                    </div>
                </div>
                
                <div class="form-row">
                    <label>Ability</label>
                    <div class="ac-wrapper">
                        <input type="text" class="inp-ability" value="${rootPkmn.ability || ''}" autocomplete="off">
                    </div>
                </div>

                <div class="iv-section-title">IVs</div>
                <div class="iv-row">
                    <div class="iv-group"><label>HP</label><input type="number" class="iv-hp" value="${ivs.hp !== undefined ? ivs.hp : 31}" min="0" max="31"></div>
                    <div class="iv-group"><label>Atk</label><input type="number" class="iv-atk" value="${ivs.atk !== undefined ? ivs.atk : 31}" min="0" max="31"></div>
                    <div class="iv-group"><label>Def</label><input type="number" class="iv-def" value="${ivs.def !== undefined ? ivs.def : 31}" min="0" max="31"></div>
                    <div class="iv-group"><label>SpA</label><input type="number" class="iv-satk" value="${ivs.satk !== undefined ? ivs.satk : 31}" min="0" max="31"></div>
                    <div class="iv-group"><label>SpD</label><input type="number" class="iv-sdef" value="${ivs.sdef !== undefined ? ivs.sdef : 31}" min="0" max="31"></div>
                    <div class="iv-group"><label>Spe</label><input type="number" class="iv-spe" value="${ivs.spe !== undefined ? ivs.spe : 31}" min="0" max="31"></div>
                </div>

                <div class="moves-box">
                    <div class="moves-title" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>MOVESET</span>
                        <button type="button" class="btn-learn-all learn-all-btn">Learn All (Lvl 100 Only)</button>
                    </div>
                    <div class="form-row"><label>M1</label><div class="ac-wrapper"><input type="text" class="move-1" value="${rootPkmn.moves.slot1 || ''}" autocomplete="off"></div></div>
                    <div class="form-row"><label>M2</label><div class="ac-wrapper"><input type="text" class="move-2" value="${rootPkmn.moves.slot2 || ''}" autocomplete="off"></div></div>
                    <div class="form-row"><label>M3</label><div class="ac-wrapper"><input type="text" class="move-3" value="${rootPkmn.moves.slot3 || ''}" autocomplete="off"></div></div>
                    <div class="form-row"><label>M4</label><div class="ac-wrapper"><input type="text" class="move-4" value="${rootPkmn.moves.slot4 || ''}" autocomplete="off"></div></div>
                </div>
            `;
            teamGrid.appendChild(card);

            // --- RESTORED LOGIC WITH SAFETY CHECK ---
            card.querySelector('.learn-all-btn').addEventListener('click', () => {
                const currentLevel = parseInt(card.querySelector('.inp-level').value) || 1;
                
                // 【修改重点】等级锁检查
                if (currentLevel !== 100) {
                    alert("⚠️ To prevent bugs (game crash/stuck level), 'Unlock All Moves' is restricted to Level 100 Pokemon only.\n⚠️ 为了防止游戏Bug（卡7级/崩溃），一键全技能仅限 100级 宝可梦使用。");
                    return;
                }

                if (!jsonData[speciesId].movepool) jsonData[speciesId].movepool = [];
                const currentPool = new Set(jsonData[speciesId].movepool);
                searchDB.moves.forEach(m => currentPool.add(m));
                jsonData[speciesId].movepool = Array.from(currentPool);
                alert(`[${speciesId}] Learned all ${searchDB.moves.length} moves! (Level 100 confirmed)`);
            });

            setupAutocomplete(card.querySelector('.inp-id'), searchDB.pkmn);
            setupAutocomplete(card.querySelector('.inp-item'), searchDB.items);
            setupAutocomplete(card.querySelector('.inp-ability'), searchDB.abilities);
            setupAutocomplete(card.querySelector('.move-1'), searchDB.moves);
            setupAutocomplete(card.querySelector('.move-2'), searchDB.moves);
            setupAutocomplete(card.querySelector('.move-3'), searchDB.moves);
            setupAutocomplete(card.querySelector('.move-4'), searchDB.moves);
        }
    }

    // --- Unlock All Dex Logic ---
    document.getElementById('unlockAllDexBtn').addEventListener('click', () => {
        if (!jsonData) return;
        const confirmUnlock = confirm("Are you sure you want to unlock ALL Pokemon (Dex)?\n确定要一键解锁图鉴中所有宝可梦吗？");
        if (!confirmUnlock) return;

        let unlockedCount = 0;
        searchDB.pkmn.forEach(speciesId => {
            if (!jsonData[speciesId]) {
                jsonData[speciesId] = {
                    caught: 1,
                    level: 1, 
                    exp: 0, 
                    shiny: false,
                    ivs: { hp:0, atk:0, def:0, satk:0, sdef:0, spe:0 },
                    moves: {}
                };
                unlockedCount++;
            } else {
                if (jsonData[speciesId].caught !== 1) {
                    jsonData[speciesId].caught = 1;
                    unlockedCount++;
                }
            }
        });

        alert(`Success! Unlocked ${unlockedCount} new Pokemon.\n成功解锁了 ${unlockedCount} 只新宝可梦！`);
        renderDex(dexSearchBox.value);
    });

    // --- Render Dex ---
    function renderDex(filter = "") {
        dexGrid.innerHTML = '';
        const keys = Object.keys(jsonData);
        
        const pkmnKeys = keys.filter(k => {
            const v = jsonData[k];
            return v && typeof v === 'object' && v.caught === 1;
        });

        pkmnKeys.forEach(speciesId => {
            if (filter && !speciesId.toLowerCase().includes(filter.toLowerCase())) return;

            const rootPkmn = jsonData[speciesId];
            const level = rootPkmn.level || 1;
            const ivs = rootPkmn.ivs || { hp:0, atk:0, def:0, satk:0, sdef:0, spe:0 };

            const card = document.createElement('div');
            card.className = 'dex-card';
            
            card.innerHTML = `
                <div class="pkmn-header">
                    <span>${speciesId}</span>
                    <label class="shiny-label">
                        <input type="checkbox" class="dex-shiny" ${rootPkmn.shiny ? 'checked' : ''}> Shiny
                    </label>
                </div>
                
                <div class="form-row">
                    <label>Level</label>
                    <input type="number" class="dex-level" value="${level}" min="1" max="100">
                </div>

                <div class="iv-section-title">IVs</div>
                <div class="iv-row">
                    <div class="iv-group"><label>H</label><input type="number" class="dex-hp" value="${ivs.hp !== undefined ? ivs.hp : 0}" min="0" max="31"></div>
                    <div class="iv-group"><label>A</label><input type="number" class="dex-atk" value="${ivs.atk !== undefined ? ivs.atk : 0}" min="0" max="31"></div>
                    <div class="iv-group"><label>B</label><input type="number" class="dex-def" value="${ivs.def !== undefined ? ivs.def : 0}" min="0" max="31"></div>
                    <div class="iv-group"><label>C</label><input type="number" class="dex-satk" value="${ivs.satk !== undefined ? ivs.satk : 0}" min="0" max="31"></div>
                    <div class="iv-group"><label>D</label><input type="number" class="dex-sdef" value="${ivs.sdef !== undefined ? ivs.sdef : 0}" min="0" max="31"></div>
                    <div class="iv-group"><label>S</label><input type="number" class="dex-spe" value="${ivs.spe !== undefined ? ivs.spe : 0}" min="0" max="31"></div>
                </div>
                <button class="btn-learn-all dex-learn-all" style="width:100%; margin-top:10px;">Learn All Moves (Lvl 100)</button>
            `;
            
            // --- RESTORED LOGIC WITH SAFETY CHECK ---
            card.querySelector('.dex-learn-all').addEventListener('click', () => {
                const currentLevel = parseInt(card.querySelector('.dex-level').value) || 1;
                
                if (currentLevel !== 100) {
                     alert("⚠️ Restricted to Level 100 only to prevent bugs.\n⚠️ 仅限 100级 使用以防止Bug。");
                    return;
                }

                if (!jsonData[speciesId].movepool) jsonData[speciesId].movepool = [];
                const currentPool = new Set(jsonData[speciesId].movepool);
                searchDB.moves.forEach(m => currentPool.add(m));
                jsonData[speciesId].movepool = Array.from(currentPool);
                alert(`[${speciesId}] Learned all moves!`);
            });

            card.querySelector('.dex-shiny').addEventListener('change', function() {
                jsonData[speciesId].shiny = this.checked;
            });
            
            card.querySelector('.dex-level').addEventListener('input', function() {
                jsonData[speciesId].level = parseInt(this.value) || 1;
            });

            const ivInputs = card.querySelectorAll('.iv-row input');
            ivInputs.forEach(inp => {
                inp.addEventListener('input', function() {
                    if(!jsonData[speciesId].ivs) jsonData[speciesId].ivs = {};
                    const val = parseInt(this.value) || 0;
                    if (this.classList.contains('dex-hp')) jsonData[speciesId].ivs.hp = val;
                    if (this.classList.contains('dex-atk')) jsonData[speciesId].ivs.atk = val;
                    if (this.classList.contains('dex-def')) jsonData[speciesId].ivs.def = val;
                    if (this.classList.contains('dex-satk')) jsonData[speciesId].ivs.satk = val;
                    if (this.classList.contains('dex-sdef')) jsonData[speciesId].ivs.sdef = val;
                    if (this.classList.contains('dex-spe')) jsonData[speciesId].ivs.spe = val;
                });
            });

            dexGrid.appendChild(card);
        });
    }

    dexSearchBox.addEventListener('input', (e) => renderDex(e.target.value));

    // --- Render Items ---
    function renderItems(filter = "") {
        itemGrid.innerHTML = '';
        const keys = Object.keys(jsonData);
        
        keys.forEach(key => {
            const val = jsonData[key];
            if (val && typeof val === 'object' && val.hasOwnProperty('got') && typeof val.got === 'number') {
                const { text, isAuto } = translateItem(key);
                const en = key;
                if (filter) {
                    const f = filter.toLowerCase();
                    if (!text.toLowerCase().includes(f) && !en.toLowerCase().includes(f)) return;
                }
                const card = document.createElement('div');
                card.className = 'item-card';
                const tag = isAuto ? `<span class="tag-auto">机翻</span>` : '';
                
                card.innerHTML = `
                    <div class="item-cn">${text} ${tag}</div>
                    <div class="item-en">${en}</div>
                    <div class="qty-row">
                        <span>数量</span>
                        <input type="number" min="0" value="${val.got}" data-key="${key}">
                    </div>
                `;
                card.querySelector('input').addEventListener('input', function() {
                    jsonData[key].got = parseInt(this.value) || 0;
                });
                itemGrid.appendChild(card);
            }
        });
    }

    itemSearchBox.addEventListener('input', (e) => renderItems(e.target.value));

    // --- 5. 保存逻辑 (DATA SANITIZATION) ---
    saveBtn.addEventListener('click', () => {
        if(!jsonData) return;
        
        const cards = teamGrid.querySelectorAll('.pkmn-card');
        
        cards.forEach(card => {
            const slotKey = card.dataset.slotKey;
            
            const idInput = card.querySelector('.inp-id');
            if (!idInput) return;

            const newId = idInput.value.trim();
            const newItem = card.querySelector('.inp-item').value.trim();
            const newAbility = card.querySelector('.inp-ability').value.trim();
            const newShiny = card.querySelector('.inp-shiny').checked;
            const newLevel = parseInt(card.querySelector('.inp-level').value) || 1;
            
            const newIvs = {
                hp: parseInt(card.querySelector('.iv-hp').value) || 0,
                atk: parseInt(card.querySelector('.iv-atk').value) || 0,
                def: parseInt(card.querySelector('.iv-def').value) || 0,
                satk: parseInt(card.querySelector('.iv-satk').value) || 0,
                sdef: parseInt(card.querySelector('.iv-sdef').value) || 0,
                spe: parseInt(card.querySelector('.iv-spe').value) || 0,
            };
            
            const m1 = card.querySelector('.move-1').value.trim() || null;
            const m2 = card.querySelector('.move-2').value.trim() || null;
            const m3 = card.querySelector('.move-3').value.trim() || null;
            const m4 = card.querySelector('.move-4').value.trim() || null;
            const newMoves = { slot1: m1, slot2: m2, slot3: m3, slot4: m4 };

            // Update Config
            if (!jsonData.saved.previewTeams[activePreviewKey][slotKey]) {
                jsonData.saved.previewTeams[activePreviewKey][slotKey] = {};
            }
            jsonData.saved.previewTeams[activePreviewKey][slotKey].pkmn = newId;
            jsonData.saved.previewTeams[activePreviewKey][slotKey].item = newItem;

            // Update Root Species Data
            if (!jsonData[newId]) {
                jsonData[newId] = {
                    caught: 1, 
                    level: newLevel,
                    ivs: newIvs,
                    moves: {}
                };
            } else {
                if (!jsonData[newId].caught) jsonData[newId].caught = 1;
            }

            // Write all props
            jsonData[newId].ability = newAbility;
            jsonData[newId].shiny = newShiny;
            jsonData[newId].moves = newMoves;
            jsonData[newId].level = newLevel;
            jsonData[newId].ivs = newIvs;
            
            // --- FIX 1: Hybrid Level Logic (保留防105级BUG的经验值逻辑) ---
            if (newLevel === 1) {
                jsonData[newId].exp = 0;
            } else {
                if (jsonData[newId].hasOwnProperty('exp')) {
                    delete jsonData[newId].exp;
                }
            }

            // --- FIX 2: CONDITIONAL Movepool Sanitization (防止降级后卡死) ---
            // 如果等级 < 100 且技能池巨大，自动清理，只保留当前携带的技能。
            // 这样如果你先改到100级解锁技能，再改回5级，这里会自动清理技能池，防止坏档。
            
            if (newLevel < 100 && jsonData[newId].movepool && jsonData[newId].movepool.length > 50) {
                // Wipe movepool for safety if level dropped below 100
                let safePool = new Set();
                if (m1) safePool.add(m1);
                if (m2) safePool.add(m2);
                if (m3) safePool.add(m3);
                if (m4) safePool.add(m4);
                jsonData[newId].movepool = Array.from(safePool);
            }

            // Update Runtime Team
            if (jsonData.team && jsonData.team[slotKey]) {
                jsonData.team[slotKey].item = newItem;
                let newPkmnObj = JSON.parse(JSON.stringify(jsonData[newId]));
                newPkmnObj.id = newId; 
                jsonData.team[slotKey].pkmn = newPkmnObj;
            }
        });

        const blob = new Blob([JSON.stringify(jsonData)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "pokechill.json";
        a.click();
        URL.revokeObjectURL(url);
    });

</script>
</body>
</html>
